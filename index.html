<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>What A App</title>
<style>
:root{--bg:#f0f2f5;--panel:#fff;--text:#111;--muted:#667;--accent:#25D366;--accent-dark:#128C7E;--bubble-me:#d9fdd3;--bubble-them:#fff;--border:#e5e7eb;--danger:#e53935;}
.dark{--bg:#0b141a;--panel:#111b21;--text:#e9edef;--muted:#aebac1;--bubble-me:#005c4b;--bubble-them:#202c33;--border:#1f2c34;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans Gujarati","Noto Sans",sans-serif}

/* Splash */
#splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#25D366;color:#fff;z-index:9999;opacity:1;transition:opacity .8s ease;}
#splash.fade{opacity:0;pointer-events:none;}
#splash .logo{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
#splash .logo-circle{width:80px;height:80px;border-radius:50%;background:#fff;color:#25D366;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:2rem;box-shadow:0 4px 12px rgba(0,0,0,.3);}
#splash .logo-text{font-size:2rem;font-weight:700;color:#fff;}
.loading{display:flex;gap:8px;}
.loading .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1.2s infinite;}
.loading .dot:nth-child(2){animation-delay:.2s}.loading .dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}

/* App shell */
.app{display:flex;flex-direction:column;height:100vh;}
.content{flex:1;display:grid;grid-template-columns:360px 1fr;min-height:0;}
@media(max-width:900px){.content{grid-template-columns:1fr;}}

/* Panels & topbar */
.panel{background:var(--panel);border-right:1px solid var(--border);min-height:0;}
.panel:last-child{border-right:none}
.topbar{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10;}
.avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:700;background:#128C7E;}
.title{font-weight:700;} .spacer{flex:1}
.iconbtn{border:none;background:transparent;cursor:pointer;font-size:1.2rem}

/* Search & lists */
.search{padding:8px 12px;border-bottom:1px solid var(--border);}
.search input{width:100%;padding:10px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--text);}
.list{overflow:auto;height:calc(100vh - 140px);}
.row{display:flex;gap:12px;padding:10px;border-bottom:1px solid var(--border);cursor:pointer;}
.row:hover{background:rgba(127,127,127,.08);}
.row .meta{flex:1;min-width:0}
.row .name{font-weight:600;}
.row .preview{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.row .right{text-align:right;color:var(--muted);font-size:.8rem;}
.badge{background:var(--accent);color:#fff;border-radius:999px;padding:2px 6px;font-size:.75rem;font-weight:700}

/* Chat */
.chat{display:flex;flex-direction:column;height:100%;}
.messages{flex:1;overflow:auto;padding:16px;background:linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,0));}
.daysep{display:inline-block;margin:12px auto;padding:6px 10px;border-radius:999px;background:rgba(127,127,127,.15);color:var(--muted);font-size:.8rem;}
.bubble{max-width:75%;padding:8px 10px;border-radius:12px;margin:6px 0;word-wrap:break-word;white-space:pre-wrap;}
.me{margin-left:auto;background:var(--bubble-me);} .them{margin-right:auto;background:var(--bubble-them);}
.meta-row{display:flex;align-items:center;gap:6px;justify-content:flex-end;color:var(--muted);font-size:.75rem;margin-top:4px;}
.tick{font-size:.9rem;}
.typing{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:.9rem;padding:6px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:blink 1.2s infinite;}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}

/* Composer */
.composer{display:flex;gap:8px;padding:8px;border-top:1px solid var(--border);background:var(--panel);}
.composer input{flex:1;padding:10px;border-radius:18px;border:1px solid var(--border);background:transparent;color:var(--text);}
.sendbtn{background:var(--accent);color:#fff;border:none;border-radius:18px;padding:10px 14px;font-weight:700;cursor:pointer}

/* Footer tabs */
.footer{display:flex;justify-content:space-around;align-items:center;padding:6px;border-top:1px solid var(--border);background:var(--panel);}
.tab{flex:1;border:none;background:transparent;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:2px;font-size:.9rem;padding:4px 0;cursor:pointer;}
.tab.active{color:var(--accent-dark);font-weight:600;} .tab span{font-size:.75rem}

/* Cards (status/community) */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;padding:12px;}
.card{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--panel);}
.card img{width:100%;display:block;} .card .p{padding:8px 10px;font-size:.9rem;color:var(--muted);}

/* Toast */
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;font-size:.9rem;opacity:0;pointer-events:none;transition:opacity .2s;z-index:50;}
.toast.show{opacity:1}

/* Modal (Add/Edit contact) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:100;}
.modal .box{width:92%;max-width:420px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;}
.modal .box h3{margin:0 0 8px 0}
.modal .box input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);margin:6px 0}
.modal .box .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.modal .box button{padding:10px 12px;border:none;border-radius:8px;cursor:pointer}
.modal .box .primary{background:var(--accent);color:#fff;font-weight:700}
.modal .box .ghost{background:transparent;border:1px solid var(--border)}
</style>
</head>
<body>
<!-- Splash -->
<div id="splash">
  <div class="logo"><div class="logo-circle">WA</div><div class="logo-text">What A App</div></div>
  <div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
</div>

<div class="app">
  <div class="content">
    <!-- Left: Contacts & tabs panels -->
    <section class="panel" id="leftPanel">
      <div class="topbar">
        <div class="avatar">WA</div><div class="title">What A App</div><div class="spacer"></div>
        <button class="iconbtn" id="addContactBtn" title="àª¨àªµà«‹ àª¸àª‚àªªàª°à«àª•">â•</button>
        <button class="iconbtn" id="toggleThemeBtn" title="àª¡àª¾àª°à«àª•/àª²àª¾àª‡àªŸ">ğŸŒ“</button>
      </div>
      <div class="search"><input id="searchInput" type="text" placeholder="àª¸àª°à«àªš àª•àª°à«‹ (àª¨àª¾àª®/àª®à«‡àª¸à«‡àªœ)" /></div>

      <div id="panel-chat" class="list"></div>

      <!-- Update (Status) -->
      <div id="panel-update" style="display:none;">
        <div class="grid" id="statusGrid"></div>
        <div style="padding:12px;">
          <input type="file" id="statusInput" accept="image/*" capture="environment" />
          <button class="sendbtn" id="addStatusBtn">àª¸à«àªŸà«‡àªŸàª¸ àª‰àª®à«‡àª°à«‹</button>
        </div>
      </div>

      <!-- Community -->
      <div id="panel-community" style="display:none;">
        <div style="padding:12px;">
          <textarea id="communityText" rows="3" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);" placeholder="àªªà«‹àª¸à«àªŸ àª²àª–à«‹â€¦"></textarea>
          <button class="sendbtn" id="addCommunityPost">àªªà«‹àª¸à«àªŸ àª•àª°à«‹</button>
        </div>
        <div class="list" id="communityList"></div>
      </div>

      <!-- Calls -->
      <div id="panel-call" style="display:none;">
        <div class="list" id="callList"></div>
        <div style="padding:12px;display:flex;gap:8px;">
          <input id="callName" type="text" placeholder="àª¨àª¾àª®" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);" />
          <select id="callType" style="padding:10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);">
            <option value="in">In</option><option value="out">Out</option><option value="missed">Missed</option>
          </select>
          <button class="sendbtn" id="addCall">àªàª¡ àª•àª°à«‹</button>
        </div>
      </div>

      <!-- Settings -->
      <div id="panel-settings" style="display:none;padding:12px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div class="avatar">WA</div>
          <div><div style="font-weight:700;">Dev</div><div style="color:var(--muted);">What A App</div></div>
        </div>
        <button class="sendbtn" id="clearDataBtn" style="background:var(--danger);">àª¡à«‡àªŸàª¾ àª•à«àª²àª¿àª¯àª°</button>
      </div>
    </section>

    <!-- Right: Chat -->
    <section class="panel chat" id="chatPanel">
      <div class="topbar">
        <div class="avatar" id="chatAvatar">A</div><div class="title" id="chatTitle">àªšà«‡àªŸ</div><div class="spacer"></div>
        <button class="iconbtn" id="cameraBtnChat" title="àª•à«‡àª®à«‡àª°àª¾">ğŸ“·</button>
        <button class="iconbtn" id="voiceCallBtn" title="àª•à«‰àª²">ğŸ“</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="typing" id="typingRow" style="display:none">àªŸàª¾àª‡àªª àª•àª°à«€ àª°àª¹à«àª¯àª¾ àª›à«‡<div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <div class="composer">
        <button class="iconbtn" id="emojiBtn">ğŸ˜Š</button>
        <input id="msgInput" type="text" placeholder="àª®à«‡àª¸à«‡àªœ àª²àª–à«‹â€¦" />
        <input type="file" id="fileInput" accept="image/*,audio/*,.pdf,.doc,.docx" style="display:none" />
        <button class="iconbtn" id="attachBtn">ğŸ“</button>
        <button class="sendbtn" id="sendBtn">àª®à«‹àª•àª²à«‹</button>
      </div>
    </section>
  </div>

  <!-- Footer tabs -->
  <nav class="footer">
    <button class="tab active" data-tab="chat">ğŸ’¬<span>àªšà«‡àªŸ</span></button>
    <button class="tab" data-tab="update">ğŸ””<span>àª…àªªàª¡à«‡àªŸ</span></button>
    <button class="tab" data-tab="community">ğŸ‘¥<span>àª•àª®à«àª¯à«àª¨àª¿àªŸà«€</span></button>
    <button class="tab" data-tab="call">ğŸ“<span>àª•à«‰àª²</span></button>
    <button class="tab" data-tab="settings">âš™ï¸<span>àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</span></button>
  </nav>
</div>

<!-- Modal: Add/Edit Contact -->
<div class="modal" id="contactModal">
  <div class="box">
    <h3 id="formTitle">àª¨àªµà«‹ àª¸àª‚àªªàª°à«àª• àª‰àª®à«‡àª°à«‹</h3>
    <input id="contactName" placeholder="àª¨àª¾àª®" />
    <input id="contactNumber" placeholder="àª¨àª‚àª¬àª° (+91â€¦)" />
    <div class="actions">
      <button class="ghost" id="cancelContactBtn">Cancel</button>
      <button class="primary" id="saveContactBtn">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* ---------- Storage & defaults ---------- */
const LS_KEY="waa_full_v1";
function ts(minAgo){return Date.now()+minAgo*60*1000}
function initials(name){const p=name.trim().split(/\s+/);return p.slice(0,2).map(x=>x[0]).join("").toUpperCase()}
function msgMe(text,ago=0){return{from:"me",text,time:ts(ago),status:"sent"}}
function msgThem(text,ago=0){return{from:"them",text,time:ts(ago)}}

const defaultContacts=[
  {id:"1",name:"àª®àª®à«àª®à«€",number:"+919876543210",color:"#e67e22",preview:"àª°àª¾àª¤à«àª°à«‡ àª¶à«àª‚ àª–àª¾àª¶à«‹?",time:ts(-30),unread:1,isGroup:false},
  {id:"2",name:"àª°àªµàª¿",number:"+919812345678",color:"#16a085",preview:"àª•àª¾àª²à«‡ àª®à«‡àªš àª›à«‡?",time:ts(-120),unread:0,isGroup:false},
  {id:"3",name:"àª¸à«àª•à«‚àª² àª—à«àª°à«àªª",number:null,color:"#8e44ad",preview:"àª®à«€àªŸàª¿àª‚àª— 5 àªµàª¾àª—à«àª¯à«‡",time:ts(-300),unread:3,isGroup:true},
  {id:"4",name:"àª¦à«€àªªàª¾",number:"+919811112222",color:"#c0392b",preview:"ğŸ‘",time:ts(-1440),unread:0,isGroup:false},
];
const defaultChats={
  "1":[msgThem("àª°àª¾àª¤à«àª°à«‡ àª¶à«àª‚ àª–àª¾àª¶à«‹?",-30),msgMe("àªªàª¨à«€àª° àªŸàª¿àª•à«àª•àª¾? ğŸ˜‹",-28)],
  "2":[msgThem("àª•àª¾àª²à«‡ àª®à«‡àªš àª›à«‡?",-120),msgMe("àª¹àª¾, 7 àªµàª¾àª—à«àª¯à«‡.",-115)],
  "3":[msgThem("àª®à«€àªŸàª¿àª‚àª— 5 àªµàª¾àª—à«àª¯à«‡",-300),msgThem("àª¸àª®àª¯àª¸àª° àª†àªµàªœà«‹.",-295)],
  "4":[msgThem("ğŸ‘",-1440)],
};
const defaultStatus=[{id:"s1",by:"Dev",img:null,text:"àª¨àªµà«‹ àªªà«àª°à«‹àªœà«‡àª•à«àªŸ!",time:ts(-60)}];
const defaultCommunity=[{id:"p1",by:"Admin",text:"àª†àªœà«‡ 6 àªµàª¾àª—à«àª¯à«‡ àª®à«€àªŸàª¿àª‚àª—.",time:ts(-180)}];
const defaultCalls=[{id:"c1",name:"àª°àªµàª¿",type:"in",time:ts(-200)},{id:"c2",name:"àª¦à«€àªªàª¾",type:"missed",time:ts(-80)}];

function loadState(){
  try{const raw=localStorage.getItem(LS_KEY);if(!raw)return{contacts:defaultContacts,chats:defaultChats,theme:"light",status:defaultStatus,community:defaultCommunity,calls:defaultCalls};return JSON.parse(raw);}
  catch(e){return{contacts:defaultContacts,chats:defaultChats,theme:"light",status:defaultStatus,community:defaultCommunity,calls:defaultCalls}}
}
function saveState(){localStorage.setItem(LS_KEY,JSON.stringify(state));showToast("Saved")}

/* ---------- State ---------- */
let state=loadState(); let currentId=null; let currentTab="chat"; let editingId=null;

/* ---------- Elements ---------- */
const contactsPanel=document.getElementById("panel-chat");
const searchInput=document.getElementById("searchInput");
const tabs=document.querySelectorAll(".footer .tab");
const panelUpdate=document.getElementById("panel-update");
const panelCommunity=document.getElementById("panel-community");
const panelCall=document.getElementById("panel-call");
const panelSettings=document.getElementById("panel-settings");

const statusGrid=document.getElementById("statusGrid");
const statusInput=document.getElementById("statusInput");
const addStatusBtn=document.getElementById("addStatusBtn");

const communityText=document.getElementById("communityText");
const addCommunityPost=document.getElementById("addCommunityPost");
const communityList=document.getElementById("communityList");

const callList=document.getElementById("callList");
const callName=document.getElementById("callName");
const callType=document.getElementById("callType");
const addCall=document.getElementById("addCall");

const toggleThemeBtn=document.getElementById("toggleThemeBtn");
const clearDataBtn=document.getElementById("clearDataBtn");
const addContactBtn=document.getElementById("addContactBtn");

const messagesEl=document.getElementById("messages");
const chatTitle=document.getElementById("chatTitle");
const chatAvatar=document.getElementById("chatAvatar");
const typingRow=document.getElementById("typingRow");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const attachBtn=document.getElementById("attachBtn");
const fileInput=document.getElementById("fileInput");
const cameraBtnChat=document.getElementById("cameraBtnChat");
const voiceCallBtn=document.getElementById("voiceCallBtn");

const toast=document.getElementById("toast");

/* Modal elements */
const contactModal=document.getElementById("contactModal");
const formTitle=document.getElementById("formTitle");
const contactName=document.getElementById("contactName");
const contactNumber=document.getElementById("contactNumber");
const saveContactBtn=document.getElementById("saveContactBtn");
const cancelContactBtn=document.getElementById("cancelContactBtn");

/* Global camera input */
const cameraInputGlobal=document.createElement("input");
cameraInputGlobal.type="file"; cameraInputGlobal.accept="image/*"; cameraInputGlobal.capture="environment"; cameraInputGlobal.style.display="none";
document.body.appendChild(cameraInputGlobal);

/* ---------- Helpers ---------- */
function formatTime(t){const d=new Date(t);const hh=String(d.getHours()).padStart(2,"0");const mm=String(d.getMinutes()).padStart(2,"0");return `${hh}:${mm}`}
function showToast(text){toast.textContent=text;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),1200)}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}
function linkify(s){return s.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>').replace(/([\w.-]+@[\w.-]+\.\w+)/g,'<a href="mailto:$1">$1</a>')}
function applyTheme(){if(state.theme==="dark")document.documentElement.classList.add("dark");else document.documentElement.classList.remove("dark")}
function tickIcon(s){if(s==="sent")return"âœ…";if(s==="delivered")return"âœ”âœ”";if(s==="read")return"âœ”âœ”";return"âœ…"}

/* ---------- Tabs ---------- */
function switchTab(tab){
  currentTab=tab; tabs.forEach(b=>b.classList.toggle("active",b.dataset.tab===tab));
  document.getElementById("panel-chat").style.display=tab==="chat"?"block":"none";
  panelUpdate.style.display=tab==="update"?"block":"none";
  panelCommunity.style.display=tab==="community"?"block":"none";
  panelCall.style.display=tab==="call"?"block":"none";
  panelSettings.style.display=tab==="settings"?"block":"none";
  document.querySelector(".search").style.display=tab==="chat"?"block":"none";
}
tabs.forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.dataset.tab)));

/* ---------- Contacts ---------- */
function renderContacts(){
  const q=(searchInput.value||"").toLowerCase();
  const items=state.contacts
    .map(c=>{
      const chat=state.chats[c.id]||[];
      const last=chat[chat.length-1];
      const preview=last?(last.text||(last.image?"ğŸ“· àª«à«‹àªŸà«‹":"")||(last.file?"ğŸ“„ àª«àª¾àª‡àª²":"")):c.preview||"";
      const time=last?last.time:c.time;
      return {...c,preview,time};
    })
    .filter(c=>!q||c.name.toLowerCase().includes(q)||(c.preview||"").toLowerCase().includes(q))
    .sort((a,b)=>b.time-a.time);

  contactsPanel.innerHTML="";
  items.forEach(c=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML=`
      <div class="avatar" style="background:${c.color}">${initials(c.name)}</div>
      <div class="meta">
        <div class="name">${escapeHtml(c.name)} ${c.isGroup?"ğŸ‘¥":""}</div>
        <div class="preview">${escapeHtml(c.preview||"")}</div>
      </div>
      <div class="right">
        <div>${formatTime(c.time)}</div>
        ${c.unread>0?`<div class="badge">${c.unread}</div>`:""}
        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="iconbtn" title="Edit" onclick="openContactForm('${c.id}')">âœï¸</button>
          ${c.number?`<button class="iconbtn" title="Call" onclick="dialNumber('${c.number}')">ğŸ“</button>`:""}
        </div>
      </div>`;
    row.addEventListener("click",()=>openChat(c.id));
    contactsPanel.appendChild(row);
  });
}
function openChat(id){
  currentId=id;
  const c=state.contacts.find(x=>x.id===id);
  chatTitle.textContent=c.name+(c.isGroup?" ğŸ‘¥":"");
  chatAvatar.textContent=initials(c.name); chatAvatar.style.background=c.color;
  c.unread=0; renderContacts(); renderMessages();
}
function dialNumber(num){ window.location.href="tel:"+num }

/* ---------- Messages ---------- */
function renderMessages(){
  const chat=state.chats[currentId]||[];
  messagesEl.innerHTML=""; let lastDay="";
  chat.forEach(m=>{
    const day=new Date(m.time).toDateString();
    if(day!==lastDay){const sep=document.createElement("div");sep.className="daysep";sep.textContent=day;messagesEl.appendChild(sep);lastDay=day;}
    const b=document.createElement("div"); b.className="bubble "+(m.from==="me"?"me":"them");
    b.innerHTML=`<div>${linkify(escapeHtml(m.text||""))}</div>
      <div class="meta-row"><span>${formatTime(m.time)}</span>${m.from==="me"?`<span class="tick">${tickIcon(m.status)}</span>`:""}</div>`;
    if(m.image){const img=document.createElement("img");img.src=m.image;img.style.maxWidth="220px";img.style.borderRadius="8px";img.style.display="block";img.style.marginTop="6px";b.appendChild(img)}
    if(m.file){const a=document.createElement("a");a.href=m.file.data;a.download=m.file.name;a.textContent=`ğŸ“„ ${m.file.name}`;a.style.display="inline-block";a.style.marginTop="6px";b.appendChild(a)}
    messagesEl.appendChild(b);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}
function sendMessage(){
  if(!currentId){showToast("àªªàª¹à«‡àª²àª¾àª‚ àªšà«‡àªŸ àªªàª¸àª‚àª¦ àª•àª°à«‹");return}
  const text=msgInput.value.trim(); if(!text)return;
  const chat=state.chats[currentId]||(state.chats[currentId]=[]);
  const m={from:"me",text,time:Date.now(),status:"sent"}; chat.push(m);
  msgInput.value=""; renderMessages(); saveState();
  setTimeout(()=>{m.status="delivered";renderMessages();saveState()},500);
  setTimeout(()=>{m.status="read";renderMessages();saveState()},1200);
  simulateTypingThenReply(currentId,"àª¬àª°àª¾àª¬àª°! âœ…");
}
function simulateTypingThenReply(id,reply){
  if(currentId!==id)return;
  typingRow.style.display="flex";
  setTimeout(()=>{
    typingRow.style.display="none";
    const chat=state.chats[id]||(state.chats[id]=[]);
    chat.push({from:"them",text:reply,time:Date.now()});
    const c=state.contacts.find(x=>x.id===id); c.time=Date.now();
    renderMessages(); renderContacts(); saveState();
  },1000);
}

/* ---------- Attachments & camera ---------- */
attachBtn.addEventListener("click",()=>fileInput.click());
fileInput.addEventListener("change",()=>{
  const file=fileInput.files?.[0]; if(!file||!currentId)return;
  const reader=new FileReader();
  reader.onload=()=>{
    const chat=state.chats[currentId]||(state.chats[currentId]=[]);
    if(file.type.startsWith("image/")){
      chat.push({from:"me",text:"ğŸ“· àª«à«‹àªŸà«‹",image:reader.result,time:Date.now(),status:"sent"});
    }else{
      chat.push({from:"me",text:"àª¡à«‹àª•à«àª¯à«àª®à«‡àª¨à«àªŸ àª®à«‹àª•àª²à«àª¯à«‹",file:{name:file.name,data:reader.result},time:Date.now(),status:"sent"});
    }
    renderMessages(); saveState();
  };
  reader.readAsDataURL(file);
});
function openCameraAndSend(){
  if(!currentId){showToast("àªªàª¹à«‡àª²àª¾àª‚ àªšà«‡àªŸ àªªàª¸àª‚àª¦ àª•àª°à«‹");return}
  cameraInputGlobal.value="";
  cameraInputGlobal.onchange=()=>{
    const file=cameraInputGlobal.files?.[0]; if(!file)return;
    const r=new FileReader();
    r.onload=()=>{
      const chat=state.chats[currentId]||(state.chats[currentId]=[]);
      chat.push({from:"me",text:"ğŸ“· àª«à«‹àªŸà«‹",image:r.result,time:Date.now(),status:"sent"});
      renderMessages(); saveState();
    };
    r.readAsDataURL(file);
  };
  cameraInputGlobal.click();
}
cameraBtnChat.addEventListener("click",openCameraAndSend);

/* ---------- Calls ---------- */
voiceCallBtn.addEventListener("click",()=>{
  const c=state.contacts.find(x=>x.id===currentId);
  if(c&&c.number){window.location.href="tel:"+c.number}else{showToast("àª† contact àªªàª¾àª¸à«‡ àª¨àª‚àª¬àª° àª¨àª¥à«€")}
});

/* ---------- Status ---------- */
function renderStatus(){
  statusGrid.innerHTML="";
  state.status.sort((a,b)=>b.time-a.time).forEach(s=>{
    const card=document.createElement("div"); card.className="card";
    if(s.img){const img=document.createElement("img");img.src=s.img;card.appendChild(img)}
    const p=document.createElement("div"); p.className="p"; p.textContent=`${s.by}: ${s.text||""} â€¢ ${formatTime(s.time)}`;
    card.appendChild(p); statusGrid.appendChild(card);
  });
}
addStatusBtn.addEventListener("click",()=>{
  const file=statusInput.files?.[0];
  const entry={id:String(Date.now()),by:"Dev",img:null,text:"",time:Date.now()};
  if(file){const r=new FileReader();r.onload=()=>{entry.img=r.result;state.status.push(entry);renderStatus();saveState();showToast("àª¸à«àªŸà«‡àªŸàª¸ àª‰àª®à«‡àª°àª¾àª¯à«‹")};r.readAsDataURL(file)}
  else{entry.text="àªŸà«‡àª•à«àª¸à«àªŸ àª¸à«àªŸà«‡àªŸàª¸";state.status.push(entry);renderStatus();saveState();showToast("àª¸à«àªŸà«‡àªŸàª¸ àª‰àª®à«‡àª°àª¾àª¯à«‹")}
});

/* ---------- Community ---------- */
function renderCommunity(){
  communityList.innerHTML="";
  state.community.sort((a,b)=>b.time-a.time).forEach(p=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML=`
      <div class="avatar" style="background:#128C7E">${initials(p.by)}</div>
      <div class="meta"><div class="name">${escapeHtml(p.by)}</div><div class="preview">${escapeHtml(p.text)}</div></div>
      <div class="right"><div>${formatTime(p.time)}</div></div>`;
    communityList.appendChild(row);
  });
}
addCommunityPost.addEventListener("click",()=>{
  const text=communityText.value.trim(); if(!text)return;
  state.community.push({id:String(Date.now()),by:"Dev",text,time:Date.now()});
  communityText.value=""; renderCommunity(); saveState(); showToast("àªªà«‹àª¸à«àªŸ àª‰àª®à«‡àª°àª¾àªˆ");
});

/* ---------- Calls log ---------- */
function renderCalls(){
  callList.innerHTML="";
  state.calls.sort((a,b)=>b.time-a.time).forEach(c=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML=`
      <div class="avatar" style="background:#16a085">${initials(c.name)}</div>
      <div class="meta"><div class="name">${escapeHtml(c.name)}</div><div class="preview">${c.type}</div></div>
      <div class="right"><div>${formatTime(c.time)}</div></div>`;
    callList.appendChild(row);
  });
}
addCall.addEventListener("click",()=>{
  const name=callName.value.trim(); const type=callType.value; if(!name)return;
  state.calls.push({id:String(Date.now()),name,type,time:Date.now()});
  callName.value=""; renderCalls(); saveState(); showToast("àª•à«‰àª² àª‰àª®à«‡àª°àª¾àª¯à«‹");
});

/* ---------- Theme & settings ---------- */
function toggleThemeFn(){state.theme=state.theme==="dark"?"light":"dark";applyTheme();saveState()}
toggleThemeBtn.addEventListener("click",toggleThemeFn);
clearDataBtn.addEventListener("click",()=>{
  if(confirm("àª¬àª§à«àª‚ localStorage àª¡à«‡àªŸàª¾ àª•à«àª²àª¿àª¯àª° àª•àª°àªµà«àª‚?")){
    localStorage.removeItem(LS_KEY); state=loadState(); applyTheme(); renderAll(); showToast("Cleared");
  }
});

/* ---------- Add/Edit Contact (modal) ---------- */
function openContactForm(id=null){
  editingId=id;
  formTitle.textContent=id?"àª¸àª‚àªªàª°à«àª• Edit àª•àª°à«‹":"àª¨àªµà«‹ àª¸àª‚àªªàª°à«àª• àª‰àª®à«‡àª°à«‹";
  if(id){
    const c=state.contacts.find(x=>x.id===id);
    contactName.value=c?.name||""; contactNumber.value=c?.number||"";
  }else{
    contactName.value=""; contactNumber.value="";
  }
  contactModal.style.display="flex";
}
function closeContactForm(){ contactModal.style.display="none"; }
cancelContactBtn.addEventListener("click",closeContactForm);
saveContactBtn.addEventListener("click",()=>{
  const name=contactName.value.trim(); const number=contactNumber.value.trim();
  if(!name||!number){showToast("àª¨àª¾àª®/àª¨àª‚àª¬àª° àª¨àª¾àª–à«‹");return;}
  if(editingId){
    const c=state.contacts.find(x=>x.id===editingId);
    c.name=name; c.number=number; c.time=Date.now();
  }else{
    const id=String(Date.now());
    state.contacts.push({id,name,number,color:"#128C7E",preview:"",time:Date.now(),unread:0,isGroup:false});
    state.chats[id]=[];
  }
  saveState(); renderContacts(); closeContactForm();
});
addContactBtn.addEventListener("click",()=>openContactForm());

/* ---------- Emoji ---------- */
const emojis=["ğŸ˜Š","ğŸ‘","ğŸ‰","ğŸ™","â¤ï¸","ğŸ”¥","ğŸ˜‚","ğŸ˜","ğŸ¥³","ğŸ¤"];
document.getElementById("emojiBtn").addEventListener("click",()=>{
  const e=emojis[Math.floor(Math.random()*emojis.length)];
  msgInput.value+=(msgInput.value?" ":"")+e; msgInput.focus();
});

/* ---------- Events ---------- */
searchInput.addEventListener("input",renderContacts);
sendBtn.addEventListener("click",sendMessage);
msgInput.addEventListener("keydown",(e)=>{if(e.key==="Enter"){e.preventDefault();sendMessage()}})
attachBtn.addEventListener("click",()=>fileInput.click());

/* ---------- Init ---------- */
function renderAll(){
  applyTheme();
  renderContacts(); renderStatus(); renderCommunity(); renderCalls();
  switchTab(currentTab);
  if(state.contacts.length && !currentId){ openChat(state.contacts[0].id); }
}
renderAll();

/* Splash fade */
setTimeout(()=>{const s=document.getElementById("splash");s.classList.add("fade");setTimeout(()=>s.remove(),800)},2000);
</script>
</body>
</html>
